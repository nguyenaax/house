<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Housing Plot Live Draft Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-header { background-color: rgba(55, 65, 81, 0.5); }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #60a5fa; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">
<!-- FORCED REFRESH October 17 -->
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-5xl sm:text-6xl font-extrabold text-blue-400">
                Guild Housing Plot Draft
            </h1>
            <p class="text-gray-400 mt-2 text-xl">The Fair Way to Claim Alliance Prime Real Estate</p>
        </header>

        <!-- Main Content Area: Map (LARGE, Full Width) -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl ring-4 ring-blue-500/50 mb-10">
            <h2 class="text-3xl font-bold mb-4 text-blue-300 text-center">Available Plots Map (54 Total)</h2>
            <!-- Image source updated and container size increased -->
            <img 
                src="https://pbs.twimg.com/media/G2qVYZsXIAABwE4.jpg:large" 
                alt="Alliance Neighborhood House Plots Map with Numbers"
                class="w-full h-auto rounded-lg shadow-lg border-2 border-gray-700"
                onerror="this.onerror=null; this.src='https://placehold.co/1200x675/1f2937/9ca3af?text=Error+Loading+Map+Check+URL';"
            >
            <p class="text-xs text-gray-500 mt-3 text-center">Reference this map for plot numbers during the live draft.</p>
            
            <!-- Claimed Plots List -->
            <div id="claimedPlotsList" class="mt-6 p-4 bg-gray-900 rounded-lg hidden">
                <h3 class="text-xl font-semibold text-yellow-400 mb-3">Claimed Plots:</h3>
                <div id="claimedPlotsContent" class="flex flex-wrap gap-2 text-lg font-mono text-white">
                    <!-- Claimed plots will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Live Pick Order Results and Plan/Log (Side-by-Side below map) -->
        <div class="grid lg:grid-cols-2 gap-10">

            <!-- Live Pick Order Results -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl ring-4 ring-blue-500/50 h-full">
                <h2 class="text-3xl font-bold mb-4 text-blue-300">LIVE Draft Pick Order & Results</h2>
                <div class="overflow-x-auto rounded-lg">
                    <table id="pickOrderTable" class="min-w-full divide-y divide-gray-700">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Rank (E)</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Winner Name (F)</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Chosen Plot (G)</th>
                            </tr>
                        </thead>
                        <tbody id="pickOrderBody" class="divide-y divide-gray-700">
                            <!-- Live pick data will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Admin Controls Form -->
                <div class="mt-8 pt-4 border-t border-gray-700">
                    <h3 class="text-2xl font-bold mb-3 text-red-400">Organizer: Submit New Pick Result</h3>
                    <form id="pickForm" class="space-y-4">
                        <div id="loadingStatus" class="hidden p-2 text-center text-lg font-semibold bg-yellow-600 text-gray-900 rounded-md">Connecting...</div>
                        <div id="messageBox" class="hidden p-3 rounded-md text-sm font-medium"></div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="rankInput" class="block text-sm font-medium text-gray-400">Rank Number (e.g., 4)</label>
                                <input type="number" id="rankInput" required min="1" max="54" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="winnerNameInput" class="block text-sm font-medium text-gray-400">Winner Name</label>
                                <input type="text" id="winnerNameInput" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="plotInput" class="block text-sm font-medium text-gray-400">Chosen Plot (e.g., Plot 52)</label>
                            <input type="text" id="plotInput" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter 'Plot X' or 'PENDING...'">
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                            Save Pick Result
                        </button>
                    </form>
                </div>
            </div>

            <!-- Detailed Plan and Entry Log -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl ring-2 ring-gray-700 h-full">
                <h2 class="text-3xl font-bold mb-4 text-blue-300 border-b border-gray-700 pb-2">Draft Process and Winner List</h2>

                <!-- Updated Content -->
                <div class="space-y-6 text-gray-300">
                    <h3 class="text-2xl font-bold text-gray-200"># Alliance Housing Plot Selection Plan</h3>
                    <p>The randomized pick order for the 26 guild members has been finalized (or will be finalized live). This board will track the selection process as each player claims their plot.</p>
                    
                    <h3 class="text-2xl font-bold text-gray-200">## Step 1: Final Pick Order List</h3>
                    <p>The names below represent the final 26 winners in the **randomized pick order**. The order in the table on the left (Rank 1 through 26) must match this list, ensuring transparency for the draft.</p>
                    
                    <h4 class="text-xl font-semibold text-blue-400">### Winner List (Current Draft Order)</h4>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="min-w-full divide-y divide-gray-700 border border-gray-700">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Rank</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Player Name</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                <!-- This list must be updated manually once the random draw is complete -->
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">1</td><td class="px-4 py-2 whitespace-nowrap text-sm">Duckiimist</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">2</td><td class="px-4 py-2 whitespace-nowrap text-sm">Kirikomain</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">3</td><td class="px-4 py-2 whitespace-nowrap text-sm">OshallÃ¡</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">4</td><td class="px-4 py-2 whitespace-nowrap text-sm">Cultzivate</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">5</td><td class="px-4 py-2 whitespace-nowrap text-sm">Meowlygos</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">6</td><td class="px-4 py-2 whitespace-nowrap text-sm">Ryxw</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">7</td><td class="px-4 py-2 whitespace-nowrap text-sm">Xephostwo</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">8</td><td class="px-4 py-2 whitespace-nowrap text-sm">Kevxh</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">9</td><td class="px-4 py-2 whitespace-nowrap text-sm">Tushytantrum</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">10</td><td class="px-4 py-2 whitespace-nowrap text-sm">Lygerxd</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">11</td><td class="px-4 py-2 whitespace-nowrap text-sm">Yakarue</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">12</td><td class="px-4 py-2 whitespace-nowrap text-sm">Bizzm</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">13</td><td class="px-4 py-2 whitespace-nowrap text-sm">Azunazx</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">14</td><td class="px-4 py-2 whitespace-nowrap text-sm">Akuwu</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">15</td><td class="px-4 py-2 whitespace-nowrap text-sm">Preyxd</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">16</td><td class="px-4 py-2 whitespace-nowrap text-sm">Fightdk</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">17</td><td class="px-4 py-2 whitespace-nowrap text-sm">Maverris</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">18</td><td class="px-4 py-2 whitespace-nowrap text-sm">Evne</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">19</td><td class="px-4 py-2 whitespace-nowrap text-sm">Garms</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">20</td><td class="px-4 py-2 whitespace-nowrap text-sm">Arzy</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">21</td><td class="px-4 py-2 whitespace-nowrap text-sm">Dabnel</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">22</td><td class="px-4 py-2 whitespace-nowrap text-sm">Subti</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">23</td><td class="px-4 py-2 whitespace-nowrap text-sm">Hypeboy</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">24</td><td class="px-4 py-2 whitespace-nowrap text-sm">Cququ</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">25</td><td class="px-4 py-2 whitespace-nowrap text-sm">Nerftank</td></tr>
                                <tr><td class="px-4 py-2 whitespace-nowrap text-sm">26</td><td class="px-4 py-2 whitespace-nowrap text-sm">Salisw</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-200">## Step 2: The Draft (Plot Selection)</h3>
                    <ol class="list-decimal list-inside ml-4 space-y-1">
                        <li>**Announce the Rank:** Announce the winner with the 1st Pick Order Rank.</li>
                        <li>**The Selection:** The player announces their choice (e.g., "I choose Plot 18").</li>
                        <li>**Immediate Update:** The organizer immediately uses the form on the left to enter the chosen plot. This updates the **LIVE Draft Pick Order & Results** table instantly.</li>
                        <li>**Repeat:** Proceed to the next Rank until all available plots are claimed.</li>
                    </ol>
                    <p class="mt-4 p-3 bg-blue-900/30 border-l-4 border-blue-500 rounded-md italic">
                        **Pro-Tip:** Ask players with the top picks to provide a shortlist of 2-3 plots they like beforehand. This keeps the draft moving quickly if their first choice is taken.
                    </p>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm">
            Draft Board generated by Guild Master (or your friendly AI Assistant). <span class="text-blue-500 font-semibold">(v1.3 Final Validation/Auth Fix)</span>
        </footer>

    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // --- GLOBAL FIREBASE CONFIG ---
        const appId = 'guild-draft-board-1'; // Hardcoded for external hosting consistency
        
        // This array will hold the current data from Firestore for validation
        let currentPicksData = []; 

        // YOU HAVE CONFIRMED THESE ARE YOUR CORRECT KEYS:
        const firebaseConfig = {
            apiKey: "AIzaSyBxl0Y7VvxDBk8BMXIi3j3QE3hFOvuPrA", 
            authDomain: "tp-house-raffle.firebaseapp.com", 
            projectId: "tp-house-raffle", 
            storageBucket: "tp-house-raffle.firebasestorage.app", 
            messagingSenderId: "886855375377", 
            appId: "1:886855375377:web:c89f6a41fc767b17242fb0"
        };
        
        const loadingStatus = document.getElementById('loadingStatus');
        const messageBox = document.getElementById('messageBox');
        const claimedPlotsList = document.getElementById('claimedPlotsList');
        const claimedPlotsContent = document.getElementById('claimedPlotsContent');
        
        let db, auth;
        const PICK_COLLECTION_PATH = `artifacts/${appId}/public/data/picks`;

        // Updated initial picks array with all 26 players
        const initialPicks = [
            { rank: 1, winnerName: "Duckiimist", chosenPlot: "PENDING..." },
            { rank: 2, winnerName: "Kirikomain", chosenPlot: "PENDING..." },
            { rank: 3, winnerName: "OshallÃ¡", chosenPlot: "PENDING..." },
            { rank: 4, winnerName: "Cultzivate", chosenPlot: "PENDING..." },
            { rank: 5, winnerName: "Meowlygos", chosenPlot: "PENDING..." },
            { rank: 6, winnerName: "Ryxw", chosenPlot: "PENDING..." },
            { rank: 7, winnerName: "Xephostwo", chosenPlot: "PENDING..." },
            { rank: 8, winnerName: "Kevxh", chosenPlot: "PENDING..." },
            { rank: 9, winnerName: "Tushytantrum", chosenPlot: "PENDING..." },
            { rank: 10, winnerName: "Lygerxd", chosenPlot: "PENDING..." },
            { rank: 11, winnerName: "Yakarue", chosenPlot: "PENDING..." },
            { rank: 12, winnerName: "Bizzm", chosenPlot: "PENDING..." },
            { rank: 13, winnerName: "Azunazx", chosenPlot: "PENDING..." },
            { rank: 14, winnerName: "Akuwu", chosenPlot: "PENDING..." },
            { rank: 15, winnerName: "Preyxd", chosenPlot: "PENDING..." },
            { rank: 16, winnerName: "Fightdk", chosenPlot: "PENDING..." },
            { rank: 17, winnerName: "Maverris", chosenPlot: "PENDING..." },
            { rank: 18, winnerName: "Evne", chosenPlot: "PENDING..." },
            { rank: 19, winnerName: "Garms", chosenPlot: "PENDING..." },
            { rank: 20, winnerName: "Arzy", chosenPlot: "PENDING..." },
            { rank: 21, winnerName: "Dabnel", chosenPlot: "PENDING..." },
            { rank: 22, winnerName: "Subti", chosenPlot: "PENDING..." },
            { rank: 23, winnerName: "Hypeboy", chosenPlot: "PENDING..." },
            { rank: 24, winnerName: "Cququ", chosenPlot: "PENDING..." },
            { rank: 25, winnerName: "Nerftank", chosenPlot: "PENDING..." },
            { rank: 26, winnerName: "Salisw", chosenPlot: "PENDING..." }
        ];

        // --- UTILITY FUNCTIONS ---

        function displayMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = isError 
                ? 'p-3 rounded-md text-sm font-medium bg-red-800 text-red-100' 
                : 'p-3 rounded-md text-sm font-medium bg-green-800 text-green-100';
            messageBox.classList.remove('hidden');
        }

        // --- DATA MANAGEMENT & RENDERING ---

        async function initializePicksIfEmpty() {
            try {
                // Initialize all 26 players on the first load
                for (const pick of initialPicks) {
                    const pickDocRef = doc(db, PICK_COLLECTION_PATH, String(pick.rank));
                    // setDoc with merge: true ensures the data structure exists without overwriting existing data
                    await setDoc(pickDocRef, pick, { merge: true });
                }
            } catch (error) {
                console.error("Error initializing mock data:", error);
            }
        }

        function renderPicks(picks) {
            const tbody = document.getElementById('pickOrderBody');
            tbody.innerHTML = '';
            
            // Store data for validation and sort by rank number
            currentPicksData = picks.sort((a, b) => a.rank - b.rank);
            
            let claimedPlots = [];

            currentPicksData.forEach(pick => {
                let statusClass = 'text-gray-500';
                let rankText = pick.rank + ' Pick';
                let plotText = pick.chosenPlot;

                if (pick.rank <= 3) {
                    rankText = pick.rank === 1 ? '1st Pick' : pick.rank === 2 ? '2nd Pick' : '3rd Pick';
                }

                // Check if plot is claimed (case-insensitive check for "Plot" followed by a number)
                const plotMatch = pick.chosenPlot ? pick.chosenPlot.match(/plot\s*(\d+)/i) : null;

                if (plotMatch) {
                    statusClass = 'text-yellow-400';
                    claimedPlots.push(pick.chosenPlot); // Store the full string for the claimed list
                } else {
                    plotText = 'PENDING...';
                    statusClass = 'text-gray-500';
                }

                const row = document.createElement('tr');
                row.className = `hover:bg-gray-700 transition duration-150 ${statusClass === 'text-gray-500' ? 'bg-gray-700/50' : ''}`;
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap font-semibold ${pick.rank <= 3 ? 'font-extrabold' : ''} ${statusClass}">${rankText}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-lg">${pick.winnerName}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-lg font-mono ${plotText === 'PENDING...' ? 'text-red-400' : 'text-green-400'}">${plotText}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Render Claimed Plots List
            claimedPlotsContent.innerHTML = claimedPlots
                .map(plot => `<span class="bg-blue-700 p-1 rounded-md text-sm">${plot.replace(/plot\s*/i, 'P')}</span>`)
                .join('');
            if (claimedPlots.length > 0) {
                claimedPlotsList.classList.remove('hidden');
            } else {
                claimedPlotsList.classList.add('hidden');
            }

            loadingStatus.classList.add('hidden');
            displayMessage("Database Connected. Ready for Draft!", false);
        }

        function setupRealtimeListener() {
            // Log path for troubleshooting permissions
            console.log("Listening on path:", PICK_COLLECTION_PATH);

            const picksQuery = collection(db, PICK_COLLECTION_PATH);
            
            // Listen for real-time updates
            onSnapshot(picksQuery, (snapshot) => {
                const picks = [];
                snapshot.forEach(doc => {
                    picks.push(doc.data());
                });
                
                if (picks.length < initialPicks.length) {
                    // Only initialize the structure if the database is missing expected documents
                    initializePicksIfEmpty();
                } 
                renderPicks(picks);
            }, (error) => {
                console.error("Error setting up real-time listener:", error);
                displayMessage("Error listening for live updates. Check console for database path or rule issues.", true);
            });
        }

        // --- PLOT VALIDATION AND FORM SUBMISSION ---

        function setupFormSubmission() {
            const form = document.getElementById('pickForm');
            const rankInput = document.getElementById('rankInput');
            const winnerNameInput = document.getElementById('winnerNameInput');
            const plotInput = document.getElementById('plotInput');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const rank = parseInt(rankInput.value);
                const winnerName = winnerNameInput.value.trim();
                const chosenPlot = plotInput.value.trim();
                
                if (isNaN(rank) || rank < 1) {
                    displayMessage("Please enter a valid rank number.", true);
                    return;
                }

                // 1. PLOT VALIDATION LOGIC
                const normalizedPlot = chosenPlot.match(/plot\s*(\d+)/i) ? chosenPlot : `Plot ${chosenPlot}`;
                
                // Check if the plot is already claimed by someone else
                const existingPick = currentPicksData.find(p => 
                    p.rank !== rank && 
                    p.chosenPlot && 
                    p.chosenPlot.toLowerCase() === normalizedPlot.toLowerCase()
                );

                if (existingPick) {
                    displayMessage(
                        `ðŸš« Plot **${normalizedPlot}** is already claimed by **${existingPick.winnerName}** (Rank ${existingPick.rank}). Please choose a different plot, or confirm a trade with them.`, 
                        true
                    );
                    return;
                }
                
                loadingStatus.textContent = `Saving Pick ${rank}...`;
                loadingStatus.classList.remove('hidden');
                messageBox.classList.add('hidden');

                try {
                    const pickDocRef = doc(db, PICK_COLLECTION_PATH, String(rank));
                    
                    await setDoc(pickDocRef, {
                        rank: rank,
                        winnerName: winnerName,
                        chosenPlot: normalizedPlot // Use the normalized format
                    }, { merge: true });

                    displayMessage(`Successfully updated Rank ${rank} for ${winnerName}! Claimed Plot ${normalizedPlot}!`, false);
                    form.reset(); 
                } catch (error) {
                    console.error("Error saving pick result:", error);
                    displayMessage(`Failed to save pick. Error: ${error.message}`, true);
                } finally {
                    loadingStatus.classList.add('hidden');
                }
            });
        }
        
        // --- AUTHENTICATION FLOW (The Final Setup) ---
        
        function initFirebase() {
            loadingStatus.textContent = "Connecting to Database...";
            loadingStatus.classList.remove('hidden');
            
            // 1. Initialize App and Services
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 2. Simplistic Auth flow for single-user (GM) operation
            // We just need to sign in anonymously to satisfy the Firestore rule: if request.auth != null
            signInAnonymously(auth).then(() => {
                // 3. Start services immediately after successful anonymous sign-in
                console.log("Anonymous user signed in successfully.");
                loadingStatus.textContent = "Database Connected. Loading Picks...";
                setupRealtimeListener();
                setupFormSubmission();
            }).catch(error => {
                console.error("Anonymous Sign-In Failed:", error);
                // If sign-in fails, display a critical error
                displayMessage("ðŸš¨ Critical Auth Error: Could not sign in. Check Anonymous Auth is enabled.", true);
                loadingStatus.classList.add('hidden');
            });
        }

        // Start the application only when the window is fully loaded
        window.onload = initFirebase;
    </script>
</body>
</html>
