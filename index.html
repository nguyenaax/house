<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Housing Plot Live Draft Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importing a Fantasy-style font -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Base Styling */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #1a1c23; /* Dark stone color */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><g fill="%23000" fill-opacity="0.1"><rect x="50" width="50" height="50"/><rect y="50" width="50" height="50"/></g></svg>');
        }
        
        .alliance-font { font-family: 'Cinzel', serif; }

        .alliance-panel {
            background-color: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            border: 2px solid;
            border-image-source: linear-gradient(to top, #ffd700, #b8860b);
            border-image-slice: 1;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3), inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        .table-header { 
            background-color: #111827;
            border-bottom: 2px solid #ffd700;
        }
        tbody tr:nth-child(odd) { background-color: rgba(30, 41, 59, 0.4); }
        tbody tr:hover { background-color: rgba(255, 215, 0, 0.1); }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #ffd700; border-radius: 4px; border: 1px solid #1e293b; }
        
        .wow-button {
            background: linear-gradient(180deg, #1e90ff 0%, #0056b3 100%);
            border: 1px solid #c4a867;
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.3), 0 2px 2px rgba(0, 0, 0, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .wow-button:hover {
            background: linear-gradient(180deg, #4caaff 0%, #1e90ff 100%);
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.4), 0 2px 4px rgba(0, 0, 0, 0.5);
            transform: translateY(-1px);
        }
        .wow-button:disabled {
            background: #555; border-color: #444; cursor: not-allowed; transform: none;
        }
        
        #diceModal {
            display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.75);
            align-items: center; justify-content: center; z-index: 50; cursor: pointer;
        }
        #dice {
            font-size: 10rem; color: white; text-shadow: 0 0 20px #ffd700;
            animation: roll 1s ease-in-out;
        }
        @keyframes roll {
            0% { transform: rotate(0deg) scale(0.5); opacity: 0; }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-screen-2xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-5xl sm:text-6xl font-extrabold text-yellow-400 alliance-font" style="text-shadow: 2px 2px 4px #000;">
                Grand Alliance Draft Board
            </h1>
            <p class="text-blue-300 mt-2 text-xl alliance-font">By Right of Conquest: Claim Your Lordship's Plot</p>
        </header>

        <div class="grid lg:grid-cols-5 gap-10">
            <!-- Left Column: Map (Wider) -->
            <div class="lg:col-span-3 alliance-panel p-6 rounded-xl">
                <h2 class="text-3xl font-bold mb-4 text-blue-400 text-center alliance-font">Available Plots Map (54 Total)</h2>
                <img 
                    src="https://raw.githubusercontent.com/nguyenaax/house/main/TP%20house%20logo.png"
                    alt="Alliance Neighborhood House Plots Map with Numbers"
                    class="w-full h-auto rounded-lg shadow-lg border-2 border-yellow-600"
                >
                <div id="claimedPlotsList" class="mt-6 p-4 bg-gray-900 rounded-lg hidden border-2 border-yellow-700">
                    <h3 class="text-xl font-semibold text-yellow-400 mb-3 alliance-font">Claimed Plots:</h3>
                    <div id="claimedPlotsContent" class="flex flex-wrap gap-2 text-lg font-mono text-white"></div>
                </div>
            </div>

            <!-- Right Column: Draft Controls & Log -->
            <div class="lg:col-span-2 space-y-10">
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl alliance-panel h-full">
                    <div id="draftControlPanel">
                        <h2 class="text-3xl font-bold text-blue-400 alliance-font text-center">Randomize Draft Order</h2>
                        <p class="text-center text-gray-300 mb-4">Click the dice to begin. This is irreversible.</p>
                        <button id="randomizeButton" class="w-full text-8xl py-4 rounded-lg shadow-lg wow-button border-yellow-400">🎲</button>
                    </div>

                    <div id="liveDraftPanel" class="hidden">
                        <h2 class="text-3xl font-bold mb-4 text-blue-400 alliance-font">Live Pick & Selection Log</h2>
                        <div id="upNextPanel" class="text-center bg-gray-900/50 p-4 rounded-lg border-2 border-yellow-500 mb-6">
                            <p id="nextPickerRank" class="text-lg text-gray-400 alliance-font">NOW PICKING</p>
                            <p id="nextPickerName" class="text-3xl font-bold text-white">...</p>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <h3 class="text-2xl font-bold mb-3 text-red-400 alliance-font">Organizer: Submit Pick</h3>
                            <form id="pickForm" class="space-y-4">
                                <div id="loadingStatus" class="hidden p-2 text-center text-lg font-semibold bg-yellow-600 text-gray-900 rounded-md">Connecting...</div>
                                <div id="messageBox" class="hidden p-3 rounded-md text-sm font-medium"></div>
                                <div>
                                    <label for="plotInput" class="block text-sm font-medium text-gray-400">Chosen Plot (1-54)</label>
                                    <input type="text" id="plotInput" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter Plot Number">
                                </div>
                                <div class="flex space-x-4">
                                    <button type="submit" class="w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white wow-button">Save Pick</button>
                                    <button type="button" id="skipButton" class="w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-gray-900 bg-yellow-500 hover:bg-yellow-600">Skip Turn</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl alliance-panel h-full">
                    <h2 class="text-3xl font-bold mb-4 text-blue-400 alliance-font">Completed Picks</h2>
                    <div class="overflow-y-auto rounded-lg max-h-96">
                        <table id="pickOrderTable" class="min-w-full divide-y divide-gray-700">
                            <thead class="table-header sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-yellow-400 uppercase tracking-wider">Rank</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-yellow-400 uppercase tracking-wider">Champion</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-yellow-400 uppercase tracking-wider">Plot Claimed</th>
                                </tr>
                            </thead>
                            <tbody id="pickOrderBody" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm">
            Draft Board v2.5 by Guild Master.
        </footer>
    </div>

    <!-- Dice Roll Modal -->
    <div id="diceModal">
        <div id="dice">⚀</div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET", messagingSenderId: "YOUR_MESSAGING_SENDER_ID", appId: "YOUR_APP_ID"
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        const PENDING = "PENDING...";
        const SKIPPED = "SKIPPED";
        
        const loadingStatus = document.getElementById('loadingStatus');
        const messageBox = document.getElementById('messageBox');
        const randomizeButton = document.getElementById('randomizeButton');
        const diceModal = document.getElementById('diceModal');
        const diceElement = document.getElementById('dice');
        const nextPickerNameEl = document.getElementById('nextPickerName');
        const nextPickerRankEl = document.getElementById('nextPickerRank');
        const draftControlPanel = document.getElementById('draftControlPanel');
        const liveDraftPanel = document.getElementById('liveDraftPanel');
        
        let db, currentPicksData = [];
        let draftOrderDetermined = false;
        const appId = firebaseConfig.appId;
        const PICK_COLLECTION_PATH = `artifacts/${appId}/public/data/picks`;
        
        const initialPlayers = [
            "Duckiimist", "Kirikomain", "Oshallá", "Cultzivate", "Meowlygos", "Ryxw", "Xephostwo", "Kevxh", "Tushytantrum", "Lygerxd", "Yakarue", "Bizzm", "Azunazx", "Akuwu", "Preyxd", "Fightdk", "Maverris", "Evne", "Garms", "Arzy", "Dabnel", "Subti", "Hypeboy", "Cququ", "Nerftank", "Salisw"
        ];

        function displayMessage(message, isError = false) {
            messageBox.innerHTML = message;
            messageBox.className = `p-3 rounded-md text-sm font-medium ${isError ? 'bg-red-800 text-red-100' : 'bg-green-800 text-green-100'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 3000);
        }

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        };
        
        function getCurrentPicker(picks) {
            const sortedPicks = picks.sort((a, b) => a.rank - b.rank);
            let picker = sortedPicks.find(p => p.chosenPlot === PENDING);
            if (!picker) {
                picker = sortedPicks.find(p => p.chosenPlot === SKIPPED);
            }
            return picker;
        }

        async function initializePicksIfEmpty() {
            try {
                const promises = initialPlayers.map((player, index) => {
                    const rank = index + 1;
                    const pickDocRef = doc(db, PICK_COLLECTION_PATH, String(rank));
                    return setDoc(pickDocRef, { rank, winnerName: player, chosenPlot: PENDING }, { merge: true });
                });
                await Promise.all(promises);
            } catch (error) { console.error("Error initializing picks:", error); }
        }

        function renderUI(picks) {
            currentPicksData = picks;
            const pickOrderBody = document.getElementById('pickOrderBody');
            const claimedPlotsContent = document.getElementById('claimedPlotsContent');
            const claimedPlotsList = document.getElementById('claimedPlotsList');
            pickOrderBody.innerHTML = '';
            
            const completedPicks = picks.filter(p => p.chosenPlot !== PENDING && p.chosenPlot !== SKIPPED).sort((a, b) => a.rank - b.rank);
            completedPicks.forEach(pick => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">${pick.rank}</td>
                    <td class="px-4 py-3 text-lg">${pick.winnerName}</td>
                    <td class="px-4 py-3 text-lg font-mono text-green-400">${pick.chosenPlot}</td>
                `;
                pickOrderBody.appendChild(row);
            });

            claimedPlotsContent.innerHTML = completedPicks.map(p => `<span class="bg-blue-700 p-1 rounded-md text-sm">${p.chosenPlot.replace(/plot\s*/i, 'P')}</span>`).join('');
            claimedPlotsList.classList.toggle('hidden', completedPicks.length === 0);

            const nextPicker = getCurrentPicker(picks);
            if (nextPicker && draftOrderDetermined) {
                nextPickerRankEl.textContent = `RANK ${nextPicker.rank} IS NOW PICKING`;
                nextPickerNameEl.textContent = nextPicker.winnerName;
                if (nextPicker.chosenPlot === SKIPPED) {
                    nextPickerRankEl.textContent += " (SKIPPED)";
                }
            } else if (!nextPicker && draftOrderDetermined) {
                nextPickerRankEl.textContent = "DRAFT COMPLETE";
                nextPickerNameEl.textContent = "All plots have been claimed!";
                document.getElementById('pickForm').style.display = 'none';
            }
        }
        
        async function handleRandomizeClick() {
            if (!confirm("Are you sure you want to randomize the draft order? This cannot be undone.")) return;
            
            randomizeButton.disabled = true;
            randomizeButton.textContent = "🎲";
            
            diceModal.style.display = 'flex';
            const diceFaces = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'];
            for (let i = 0; i < 10; i++) {
                diceElement.textContent = diceFaces[Math.floor(Math.random() * 6)];
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            setTimeout(() => { diceModal.style.display = 'none'; }, 500);

            const shuffledPlayers = [...initialPlayers];
            shuffleArray(shuffledPlayers);
            const newPickOrder = shuffledPlayers.map((player, index) => ({
                rank: index + 1, winnerName: player, chosenPlot: PENDING
            }));

            try {
                const promises = newPickOrder.map(pick => setDoc(doc(db, PICK_COLLECTION_PATH, String(pick.rank)), pick));
                await Promise.all(promises);
                draftOrderDetermined = true;
                displayMessage("Draft order has been successfully randomized!", false);
                draftControlPanel.classList.add('hidden');
                liveDraftPanel.classList.remove('hidden');
            } catch (error) {
                console.error("Error updating randomized order:", error);
                displayMessage("Failed to save the new order. Please check console.", true);
                randomizeButton.disabled = false;
            }
        }
        
        function setupEventListeners() {
            randomizeButton.addEventListener('click', handleRandomizeClick);
            diceModal.addEventListener('click', () => { diceModal.style.display = 'none'; });

            document.getElementById('pickForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const currentPicker = getCurrentPicker(currentPicksData);
                if (!currentPicker) return displayMessage("Draft is complete.", true);
                
                const plotInput = document.getElementById('plotInput');
                const chosenPlot = plotInput.value.trim();
                const normalizedPlot = `Plot ${chosenPlot.replace(/\D/g, '')}`;

                const isClaimed = currentPicksData.some(p => p.chosenPlot.toLowerCase() === normalizedPlot.toLowerCase());
                if (isClaimed) return displayMessage(`🚫 Plot <b>${normalizedPlot}</b> is already claimed.`, true);
                
                try {
                    const pickDocRef = doc(db, PICK_COLLECTION_PATH, String(currentPicker.rank));
                    await setDoc(pickDocRef, { chosenPlot: normalizedPlot }, { merge: true });
                    displayMessage(`Successfully claimed ${normalizedPlot} for ${currentPicker.winnerName}!`, false);
                    e.target.reset();
                } catch (error) { displayMessage(`Failed to save pick: ${error.message}`, true); }
            });

            document.getElementById('skipButton').addEventListener('click', async () => {
                const currentPicker = getCurrentPicker(currentPicksData);
                if (!currentPicker) return displayMessage("Draft is complete.", true);
                try {
                    const pickDocRef = doc(db, PICK_COLLECTION_PATH, String(currentPicker.rank));
                    await setDoc(pickDocRef, { chosenPlot: SKIPPED }, { merge: true });
                    displayMessage(`${currentPicker.winnerName} has been skipped.`, false);
                } catch (error) { displayMessage(`Failed to skip: ${error.message}`, true); }
            });
        }
        
        function initApp() {
            loadingStatus.textContent = "Connecting to Database...";
            loadingStatus.classList.remove('hidden');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                onSnapshot(collection(db, PICK_COLLECTION_PATH), (snapshot) => {
                    const picks = snapshot.docs.map(doc => doc.data());
                    if (picks.length === 0) {
                        initializePicksIfEmpty();
                    } else {
                        const isRandomized = picks.sort((a,b) => a.rank - b.rank).some((pick, index) => pick.winnerName !== initialPlayers[index]);
                        if (isRandomized) {
                            draftOrderDetermined = true;
                            draftControlPanel.classList.add('hidden');
                            liveDraftPanel.classList.remove('hidden');
                        }
                    }
                    renderUI(picks);
                }, (error) => {
                    displayMessage("Error listening for updates. Check Firestore rules.", true);
                });

                setupEventListeners();
            } catch (error) {
                displayMessage("Connection failed. Check your Firebase config object.", true);
                loadingStatus.classList.add('hidden');
            }
        }

        window.onload = initApp;
    </script>
</body>
</html>
