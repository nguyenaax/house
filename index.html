<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Housing Plot Live Draft Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-header { background-color: rgba(55, 65, 81, 0.5); }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #60a5fa; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-5xl sm:text-6xl font-extrabold text-blue-400">
                Guild Housing Plot Draft
            </h1>
            <p class="text-gray-400 mt-2 text-xl">The Fair Way to Claim Alliance Prime Real Estate</p>
        </header>

        <!-- Main Content Area: Map (LARGE, Full Width) -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl ring-4 ring-blue-500/50 mb-10">
            <h2 class="text-3xl font-bold mb-4 text-blue-300 text-center">Available Plots Map (54 Total)</h2>
            <!-- Image source updated and container size increased -->
            <img 
                src="https://pbs.twimg.com/media/G2qVYZsXIAABwE4.jpg:large" 
                alt="Alliance Neighborhood House Plots Map with Numbers"
                class="w-full h-auto rounded-lg shadow-lg border-2 border-gray-700"
                onerror="this.onerror=null; this.src='https://placehold.co/1200x675/1f2937/9ca3af?text=Error+Loading+Map+Check+URL';"
            >
            <p class="text-xs text-gray-500 mt-3 text-center">Reference this map for plot numbers during the live draft.</p>
        </div>
        
        <!-- Live Pick Order Results and Plan/Log (Side-by-Side below map) -->
        <div class="grid lg:grid-cols-2 gap-10">

            <!-- Live Pick Order Results -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl ring-4 ring-blue-500/50 h-full">
                <h2 class="text-3xl font-bold mb-4 text-blue-300">LIVE Draft Pick Order & Results</h2>
                <div class="overflow-x-auto rounded-lg">
                    <table id="pickOrderTable" class="min-w-full divide-y divide-gray-700">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Rank (E)</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Winner Name (F)</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Chosen Plot (G)</th>
                            </tr>
                        </thead>
                        <tbody id="pickOrderBody" class="divide-y divide-gray-700">
                            <!-- Live pick data will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Admin Controls Form -->
                <div class="mt-8 pt-4 border-t border-gray-700">
                    <h3 class="text-2xl font-bold mb-3 text-red-400">Organizer: Submit New Pick Result</h3>
                    <form id="pickForm" class="space-y-4">
                        <div id="loadingStatus" class="hidden p-2 text-center text-lg font-semibold bg-yellow-600 text-gray-900 rounded-md">Loading...</div>
                        <div id="messageBox" class="hidden p-3 rounded-md text-sm font-medium"></div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="rankInput" class="block text-sm font-medium text-gray-400">Rank Number (e.g., 4)</label>
                                <input type="number" id="rankInput" required min="1" max="54" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="winnerNameInput" class="block text-sm font-medium text-gray-400">Winner Name</label>
                                <input type="text" id="winnerNameInput" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="plotInput" class="block text-sm font-medium text-gray-400">Chosen Plot (e.g., Plot 52)</label>
                            <input type="text" id="plotInput" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter 'Plot X' or 'PENDING...'">
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                            Save Pick Result
                        </button>
                    </form>
                </div>
            </div>

            <!-- Detailed Plan and Entry Log -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl ring-2 ring-gray-700 h-full">
                <h2 class="text-3xl font-bold mb-4 text-blue-300 border-b border-gray-700 pb-2">Raffle Process and Entry Log</h2>

                <!-- Housing_Raffle_Plan.md Content -->
                <div class="space-y-6 text-gray-300">
                    <h3 class="text-2xl font-bold text-gray-200"># Alliance Housing Plot Raffle & Draft Plan</h3>
                    <p>This document outlines a fair, three-step process for managing the guild housing plot selection, from entry sign-up to the final draft.</p>

                    <h4 class="text-xl font-semibold text-blue-400">### Raffle Entry Log Template</h4>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="min-w-full divide-y divide-gray-700 border border-gray-700">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Column (A)</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Character Name (B)</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Entry Method (C)</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Tickets/Multiplier (D)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                <!-- Mock Entry Log Data -->
                                <tr class="bg-gray-900/50">
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">1</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">Thordar</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">500g Donation</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">1 (Standard)</td>
                                </tr>
                                <tr class="bg-gray-900/50">
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">2</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">Grizelda</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">Event Winner</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">1 (Standard)</td>
                                </tr>
                                <tr class="bg-gray-900/50">
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">3</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">Balthazar</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">500g Donation</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm">1 (Standard)</td>
                                </tr>
                                <!-- ... more entries follow ... -->
                            </tbody>
                        </table>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-200">## Step 2: The Raffle (Generating the Pick Order)</h3>
                    
                    <h4 class="text-xl font-semibold text-blue-400">### Recommended Method: Random Number Generator (RNG)</h4>
                    <ol class="list-decimal list-inside ml-4 space-y-1">
                        <li>**List Participants for RNG:** Take the final list of names from the **Raffle Entry Log** (Column B, <code>Character Name</code>).</li>
                        <li>**Generate Random Order:** Use a reliable and public online random list generator (e.g., Google's "random list generator" or a dedicated website like random.org).</li>
                        <li>**Run the Draw LIVE:** Share your screen on Discord or a voice chat channel and run the list generator. This visual confirmation is crucial.</li>
                        <li>**The Result:** The resulting randomized list dictates the pick order. The name at **Position 1** gets the first choice, **Position 2** gets the second choice, and so on.</li>
                    </ol>

                    <h3 class="text-2xl font-bold text-gray-200">## Step 3: The Draft (Plot Selection)</h3>
                    <ol class="list-decimal list-inside ml-4 space-y-1">
                        <li>**Announce the Rank:** Announce the winner with the 1st Pick Order Rank.</li>
                        <li>**The Selection:** The player announces their choice (e.g., "I choose Plot 18").</li>
                        <li>**Immediate Update:** The organizer immediately enters the chosen plot into the **Chosen Plot (Result)** column (in the table above) and marks the plot as "TAKEN" on the main reference map.</li>
                        <li>**Repeat:** Proceed to the 2nd Rank, 3rd Rank, and so on, until all available plots are claimed or all winners have chosen.</li>
                    </ol>
                    <p class="mt-4 p-3 bg-blue-900/30 border-l-4 border-blue-500 rounded-md italic">
                        **Pro-Tip:** Ask players with the top 5 picks to provide a shortlist of 2-3 plots they like beforehand. This keeps the draft moving quickly if their first choice is taken.
                    </p>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm">
            Draft Board generated by Guild Master (or your friendly AI Assistant).
        </footer>

    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE CONFIG ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const loadingStatus = document.getElementById('loadingStatus');
        const messageBox = document.getElementById('messageBox');
        
        let db, auth;
        const PICK_COLLECTION_PATH = `artifacts/${appId}/public/data/picks`;

        const initialPicks = [
            { rank: 1, winnerName: "Thordar", chosenPlot: "Plot 18" },
            { rank: 2, winnerName: "Grizelda", chosenPlot: "Plot 44" },
            { rank: 3, winnerName: "Balthazar", chosenPlot: "Plot 3" },
            { rank: 4, winnerName: "Anya", chosenPlot: "PENDING..." },
            { rank: 5, winnerName: "Drogon", chosenPlot: "PENDING..." },
            // You can manually add more names here once the RNG results are complete.
        ];

        // --- UTILITY FUNCTIONS ---

        function displayMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = isError 
                ? 'p-3 rounded-md text-sm font-medium bg-red-800 text-red-100' 
                : 'p-3 rounded-md text-sm font-medium bg-green-800 text-green-100';
            messageBox.classList.remove('hidden');
        }

        async function exponentialBackoffFetch(url, options, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (retries === 0) {
                    throw error;
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                return exponentialBackoffFetch(url, options, retries - 1, delay * 2);
            }
        }
        
        // --- FIREBASE INITIALIZATION ---

        async function initFirebase() {
            if (!firebaseConfig) {
                displayMessage("Error: Firebase configuration is missing.", true);
                return;
            }

            try {
                loadingStatus.textContent = "Connecting to Database...";
                loadingStatus.classList.remove('hidden');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                loadingStatus.textContent = "Database Connected. Loading Picks...";
                setupRealtimeListener();
                setupFormSubmission();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                displayMessage(`Error connecting to database. See console for details.`, true);
                loadingStatus.classList.add('hidden');
            }
        }

        // --- DATA MANAGEMENT ---

        async function initializePicksIfEmpty() {
            try {
                for (const pick of initialPicks) {
                    const pickDocRef = doc(db, PICK_COLLECTION_PATH, String(pick.rank));
                    // Use setDoc with merge: true to avoid overwriting existing data, but ensure names exist
                    await setDoc(pickDocRef, pick, { merge: true });
                }
            } catch (error) {
                console.error("Error initializing mock data:", error);
            }
        }

        function renderPicks(picks) {
            const tbody = document.getElementById('pickOrderBody');
            tbody.innerHTML = '';
            
            // Sort picks by rank number
            picks.sort((a, b) => a.rank - b.rank);

            picks.forEach(pick => {
                let statusClass = 'text-gray-500';
                let rankText = pick.rank + ' Pick';
                let plotText = pick.chosenPlot;

                if (pick.rank === 1) {
                    rankText = '1st Pick';
                } else if (pick.rank === 2) {
                    rankText = '2nd Pick';
                } else if (pick.rank === 3) {
                    rankText = '3rd Pick';
                }

                if (pick.chosenPlot && pick.chosenPlot.toLowerCase() !== 'pending...') {
                    statusClass = pick.rank === 1 ? 'text-green-400' : 'text-yellow-400';
                } else {
                    plotText = 'PENDING...';
                    statusClass = 'text-gray-500';
                }

                const row = document.createElement('tr');
                row.className = `hover:bg-gray-700 transition duration-150 ${statusClass === 'text-gray-500' ? 'bg-gray-700/50' : ''}`;
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap font-semibold ${pick.rank <= 3 ? 'font-extrabold' : ''} ${statusClass}">${rankText}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-lg">${pick.winnerName}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-lg font-mono ${plotText === 'PENDING...' ? 'text-red-400' : 'text-yellow-400'}">${plotText}</td>
                `;
                tbody.appendChild(row);
            });
            loadingStatus.classList.add('hidden');
        }

        function setupRealtimeListener() {
            const picksQuery = collection(db, PICK_COLLECTION_PATH);
            
            // Listen for real-time updates
            onSnapshot(picksQuery, (snapshot) => {
                const picks = [];
                snapshot.forEach(doc => {
                    picks.push(doc.data());
                });
                if (picks.length === 0) {
                    // If the collection is empty, initialize the mock data for the first time
                    initializePicksIfEmpty();
                } else {
                    renderPicks(picks);
                }
            }, (error) => {
                console.error("Error setting up real-time listener:", error);
                displayMessage("Error listening for live updates. Check connection.", true);
            });
        }

        // --- FORM SUBMISSION ---

        function setupFormSubmission() {
            const form = document.getElementById('pickForm');
            const rankInput = document.getElementById('rankInput');
            const winnerNameInput = document.getElementById('winnerNameInput');
            const plotInput = document.getElementById('plotInput');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const rank = parseInt(rankInput.value);
                const winnerName = winnerNameInput.value.trim();
                const chosenPlot = plotInput.value.trim();
                
                if (isNaN(rank) || rank < 1) {
                    displayMessage("Please enter a valid rank number.", true);
                    return;
                }

                loadingStatus.textContent = `Saving Pick ${rank}...`;
                loadingStatus.classList.remove('hidden');
                messageBox.classList.add('hidden');

                try {
                    const pickDocRef = doc(db, PICK_COLLECTION_PATH, String(rank));
                    
                    await setDoc(pickDocRef, {
                        rank: rank,
                        winnerName: winnerName,
                        chosenPlot: chosenPlot
                    }, { merge: true });

                    displayMessage(`Successfully updated Rank ${rank} for ${winnerName}!`, false);
                    form.reset(); 
                } catch (error) {
                    console.error("Error saving pick result:", error);
                    displayMessage(`Failed to save pick. Error: ${error.message}`, true);
                } finally {
                    loadingStatus.classList.add('hidden');
                }
            });
        }

        // Start the application
        window.onload = initFirebase;
    </script>
</body>
</html>
